service: cmcs-eregs-static-assets

provider:
  name: aws
  runtime: python3.9
  region: us-east-1
  deploymentBucket:
    blockPublicAccess: true

custom:
  stage: ${opt:stage, self:provider.stage}
  settings:
    deploy: ${env:DEPLOY, ""} # Deploy number for experimental, typically PR number
    stage_id: ${self:custom.stage}${self:custom.settings.deploy}
    isLocalStack:
      local: true
      exp: false
      dev: false
      val: false
      prod: false
    webacl_id:
      local: ""
      exp: !GetAtt CloudFrontWebACL.Arn
      dev: !GetAtt CloudFrontWebACL.Arn
      val: !GetAtt CloudFrontWebACL.Arn
      prod: !GetAtt CloudFrontWebACL.Arn
  localstack:
    stages:
      - local
  s3Sync:
    localstack: ${self:custom.settings.isLocalStack.${self:custom.stage}}
    buckets:
      - bucketName: eregs-${self:custom.settings.stage_id}-site-assets
        localDir: ./regulations
        deleteRemoved: false
  pythonRequirements:
    layer:
      name: python-django
      description: "Layer which contains django requirements"
      compatibleRuntimes:
        - python3.9

package:
  individually: false
  exclude:
    - node_modules/**
    - nginx/**

plugins:
  - serverless-python-requirements
  - serverless-localstack
  - serverless-s3-sync

resources:
  Conditions:
    IsNotLocal: !Not [!Equals ["local", "${self:custom.stage}"]]

  Resources:
    AssetsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: eregs-${self:custom.settings.stage_id}-site-assets
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: AES256
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        CorsConfiguration:
          CorsRules:
            -
              AllowedOrigins:
                - '*'
              AllowedHeaders:
                - '*'
              AllowedMethods:
                - GET
                - HEAD
              MaxAge: 3000

    CloudFrontOriginAccessIdentity:
      Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
      Properties:
        CloudFrontOriginAccessIdentityConfig:
          Comment: OAI to prevent direct public access to the bucket

    BucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action: 's3:GetObject'
              Resource: !Join
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref AssetsBucket
                  - /*
              Principal:
                CanonicalUser:
                  Fn::GetAtt:
                  - CloudFrontOriginAccessIdentity
                  - S3CanonicalUserId
            - Effect: Deny
              Action: 's3:*'
              Resource:
                - !Join
                  - ''
                  - - 'arn:aws:s3:::'
                    - !Ref AssetsBucket
                    - /*
                - !Join
                  - ''
                  - - 'arn:aws:s3:::'
                    - !Ref AssetsBucket
              Principal: '*'
              Condition:
                Bool:
                  aws:SecureTransport: false
        Bucket: !Ref AssetsBucket

    CloudFrontWebACL:
      Type: AWS::WAFv2::WebACL
      Condition: IsNotLocal
      Properties:
        Name: eregs-${self:custom.settings.stage_id}-cloudfront-ACL
        DefaultAction: 
          Allow: {}
        Scope: CLOUDFRONT
        VisibilityConfig:
          SampledRequestsEnabled: true
          CloudWatchMetricsEnabled: true
          MetricName: eregs-${self:custom.settings.stage_id}-cloudfront-metric
        Rules:
          - Name: eregs-allow-usa-plus-territories-rule-cf
            Priority: 0
            Statement:
              GeoMatchStatement:
                CountryCodes:
                  - GU
                  - PR
                  - US
                  - UM
                  - VI
                  - MP
                  - AS
            Action:
              Allow: {}
            VisibilityConfig:
              SampledRequestsEnabled: true
              CloudWatchMetricsEnabled: true
              MetricName: eregs-allow-usa-plus-territories-metric-CLOUDFRONT

    CloudFrontDistribution:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          Comment: CloudFront Distro for the static website hosted in S3
          WebACLId: ${self:custom.settings.webacl_id.${self:custom.stage}}
          Aliases:
            - Ref: AWS::NoValue
          Origins:
            - DomainName:
                Fn::GetAtt:
                  - AssetsBucket
                  - DomainName
              Id: S3Origin
              S3OriginConfig:
                OriginAccessIdentity:
                  Fn::Join:
                  - ''
                  - - origin-access-identity/cloudfront/
                    - Ref: CloudFrontOriginAccessIdentity
          Enabled: true
          HttpVersion: 'http2'
          DefaultCacheBehavior:
            AllowedMethods:
              - GET
              - HEAD
            Compress: true
            ForwardedValues:
              QueryString: false
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
          ViewerCertificate:
            AcmCertificateArn: ${ssm:/eregulations/acm-cert-arn}
            SslSupportMethod: sni-only
            MinimumProtocolVersion: TLSv1.2_2021
          DefaultRootObject: index.html

  Outputs:
    CloudFrontDistributionId:
      Value:
        Ref: CloudFrontDistribution
    StaticURL:
      Value:
        Fn::Join:
          - ''
          -
            - https://
            - Fn::GetAtt:
              - CloudFrontDistribution
              - DomainName
