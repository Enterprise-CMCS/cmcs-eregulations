name: Deploy to Environment

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      stage_name:
        required: true
        type: string
      pr_number:
        required: false
        type: string
        default: ""
      aws_default_region:
        required: true
        type: string
      invalidate_cache:
        required: false
        type: boolean
        description: 'Whether to invalidate the CloudFront cache after deployment'
        default: false
    secrets:
      AWS_OIDC_ROLE_TO_ASSUME:
        required: true
        description: 'AWS OIDC role to assume for deployment'
      PR_OBSERVER_SLACK_WEBHOOK_URL:
        required: false
        description: "The Slack webhook URL for PR observer notifications"

permissions:
  id-token: write
  contents: read
  actions: read
  pull-requests: write

jobs:
  deploy-static-assets:
    environment: ${{ inputs.environment }}
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: true

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip uv
          pushd solution/backend
          uv sync --locked --no-install-project
          popd

      - name: Make envfile
        uses: SpicyPizza/create-envfile@v2.0
        with:
          directory: solution/ui/regulations/eregs-vite
          file_name: .env

      - name: Run collectstatic
        env:
          STATIC_URL: http://localhost:8888/  # This is a placeholder value, but it is required for the command to run
          STATIC_ROOT: ../static-assets/regulations
          VITE_ENV: ${{ inputs.stage_name }}
        run: |
          pushd solution/backend
          uv run python manage.py collectstatic --noinput
          cd ..
          popd

      # Previously this was done in a separate step because Django required the CloudFront distro URL and Vue required
      # the Django URL, leading to a circular dependency that could only be resolved by deploying static assets twice.
      # But now build and deploy can be done in the same step as Vue gets the site URL from Django at runtime.
      - name: Build Vite assets
        env:
          STATIC_ROOT: ../static-assets/regulations
          VITE_ENV: ${{ inputs.stage_name }}
        run: |
          pushd solution
          make regulations
          popd

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_TO_ASSUME }}
          aws-region: ${{ inputs.aws_default_region }}

      - name: Deploy Static Assets
        env:
          STAGE_NAME: ${{ inputs.stage_name }}
          ENVIRONMENT: ${{ inputs.environment }}
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          pushd cdk-eregs
          npm install
          npm install fs-extra
          npm install --save-dev @types/fs-extra
          STATICASSET_STACK="cms-eregs-${STAGE_NAME}-static-assets"
          npx cdk deploy ${STATICASSET_STACK} \
          -c environment=${ENVIRONMENT} \
          --require-approval never \
          --exclusively \
          --app "npx ts-node bin/static-assets.ts"
          popd

      - name: Create CloudFront invalidation
        if: ${{ inputs.invalidate_cache }}
        env:
          STAGE_NAME: ${{ inputs.stage_name }}
        run: |
          DISTRIBUTION_ID=$(aws cloudformation list-stack-resources --stack-name cms-eregs-${STAGE_NAME}-static-assets | jq -r '.StackResourceSummaries[] | select(.ResourceType == "AWS::CloudFront::Distribution") | .PhysicalResourceId')
          aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"

      - name: Notify Slack if failure occurs during cache invalidation
        if: ${{ inputs.pr_number == '' && failure() }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.PR_OBSERVER_SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: "<!channel> :warning: Deployment to *${{ inputs.environment }}* failed during CloudFront cache invalidation. Please investigate. <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run.>"



  deploy-alternate-sites:
    runs-on: ubuntu-22.04
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_TO_ASSUME }}
          aws-region: ${{ inputs.aws_default_region }}

      - name: Deploy ZIP-based Lambdas
        env:
          STAGE_NAME: ${{ inputs.stage_name }}
          ENVIRONMENT: ${{ inputs.environment }}
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          pushd cdk-eregs
          npm install

          # Get exact stack names
          REDIRECT_STACK="cms-eregs-${STAGE_NAME}-redirect-api"
          MAINTENANCE_STACK="cms-eregs-${STAGE_NAME}-maintenance-api"

          npx cdk deploy ${REDIRECT_STACK} ${MAINTENANCE_STACK} \
          -c environment=${ENVIRONMENT} \
          --require-approval never \
          --exclusively \
          --app "npx ts-node bin/zip-lambdas.ts"
          popd

      - name: Notify Slack if failure occurs during deploy-alternate-sites
        if: ${{ inputs.pr_number == '' && failure() }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.PR_OBSERVER_SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: "<!channel> :warning: Deployment to *${{ inputs.environment }}* failed during alternate sites deployment. Please investigate. <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run.>"

  deploy-text-extractor:
    runs-on: ubuntu-22.04
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_TO_ASSUME }}
          aws-region: ${{ inputs.aws_default_region }}

      - name: Deploy Text Extractor
        env:
          STAGE_NAME: ${{ inputs.stage_name }}
          ENVIRONMENT: ${{ inputs.environment }}
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          pushd cdk-eregs
          npm install

          TEXT_EXTRACTOR_STACK="cms-eregs-${STAGE_NAME}-text-extractor"

          npx cdk deploy $TEXT_EXTRACTOR_STACK \
          -c environment=${ENVIRONMENT} \
          --require-approval never \
          --exclusively \
          --app "npx ts-node bin/text-extractor.ts"
          popd

      - name: Notify Slack if failure occurs during text extractor deployment
        if: ${{ inputs.pr_number == '' && failure() }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.PR_OBSERVER_SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: "<!channel> :warning: Deployment to *${{ inputs.environment }}* failed during text extractor deployment. Please investigate. <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run.>"

  deploy-fr-parser:
    needs: [deploy-site]
    runs-on: ubuntu-22.04
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_TO_ASSUME }}
          aws-region: ${{ inputs.aws_default_region }}

      - name: Deploy FR Parser
        env:
          STAGE_NAME: ${{ inputs.stage_name }}
          ENVIRONMENT: ${{ inputs.environment }}
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          pushd cdk-eregs
          npm install

          FR_PARSER_STACK="cms-eregs-${STAGE_NAME}-fr-parser"

          npx cdk deploy $FR_PARSER_STACK \
          -c environment=${ENVIRONMENT} \
          --require-approval never \
          --exclusively \
          --app "npx ts-node bin/docker-lambdas.ts"
          popd

      - name: Notify Slack if failure occurs during fr parser deployment
        if: ${{ inputs.pr_number == '' && failure() }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.PR_OBSERVER_SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: "<!channel> :warning: Deployment to *${{ inputs.environment }}* failed during FR parser deployment. Please investigate. <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run.>"

  deploy-ecfr-parser:
    needs: [deploy-site]
    runs-on: ubuntu-22.04
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_TO_ASSUME }}
          aws-region: ${{ inputs.aws_default_region }}

      - name: Deploy ECFR Parser
        env:
          STAGE_NAME: ${{ inputs.stage_name }}
          ENVIRONMENT: ${{ inputs.environment }}
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          pushd cdk-eregs
          npm install

          ECFR_PARSER_STACK="cms-eregs-${STAGE_NAME}-ecfr-parser"

          npx cdk deploy $ECFR_PARSER_STACK \
          -c environment=${ENVIRONMENT} \
          --require-approval never \
          --exclusively \
          --app "npx ts-node bin/docker-lambdas.ts"
          popd

      - name: Notify Slack if failure occurs during ecfr parser deployment
        if: ${{ inputs.pr_number == '' && failure() }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.PR_OBSERVER_SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: "<!channel> :warning: Deployment to *${{ inputs.environment }}* failed during eCFR parser deployment. Please investigate. <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run.>"

  deploy-parser-launcher:
    needs: [deploy-ecfr-parser, deploy-fr-parser]
    runs-on: ubuntu-22.04
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_TO_ASSUME }}
          aws-region: ${{ inputs.aws_default_region }}

      - name: Deploy Parser Launcher
        env:
          STAGE_NAME: ${{ inputs.stage_name }}
          ENVIRONMENT: ${{ inputs.environment }}
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          pushd cdk-eregs
          npm install

          PARSER_LAUNCHER_STACK="cms-eregs-${STAGE_NAME}-parser-launcher"

          npx cdk deploy $PARSER_LAUNCHER_STACK \
          -c environment=${ENVIRONMENT} \
          --require-approval never \
          --exclusively \
          --app "npx ts-node bin/docker-lambdas.ts"
          popd

      - name: Notify Slack if failure occurs during deploy-parser-launcher
        if: ${{ inputs.pr_number == '' && failure() }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.PR_OBSERVER_SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: "<!channel> :warning: Deployment to *${{ inputs.environment }}* failed during parser launcher deployment. Please investigate. <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run.>"

  deploy-site:
    needs: [deploy-static-assets, deploy-text-extractor]
    runs-on: ubuntu-22.04
    environment: ${{ inputs.environment }}
    outputs:
      api_url: ${{ steps.get-api-url.outputs.api_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_TO_ASSUME }}
          aws-region: ${{ inputs.aws_default_region }}

      - name: Deploy Site-Lambda
        env:
          STAGE_NAME: ${{ inputs.stage_name }}
          ENVIRONMENT: ${{ inputs.environment }}
          PR_NUMBER: ${{ inputs.pr_number }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          pushd cdk-eregs
          npm install

          API_STACK="cms-eregs-${STAGE_NAME}-api"

          npx cdk deploy $API_STACK \
          -c environment=${ENVIRONMENT} \
          -c buildId="${GITHUB_RUN_ID}" \
          -c forceDeploy=$(date +%s) \
          --require-approval never \
          --exclusively \
          --app "npx ts-node bin/docker-lambdas.ts" \
          --outputs-file api-outputs.json
          popd

      - name: Invoke setup functions after site lambdas deployed
        env:
          STAGE_NAME: ${{ inputs.stage_name }}
        run: |
          aws lambda invoke --function-name cms-eregs-${STAGE_NAME}-createdb /dev/stdout | tee -a aws.log
          aws lambda invoke --function-name cms-eregs-${STAGE_NAME}-migrate /dev/stdout | tee -a aws.log
          aws lambda invoke --function-name cms-eregs-${STAGE_NAME}-createsu /dev/stdout | tee -a aws.log
          # Check for invocation errors
          ! grep -q FunctionError aws.log

      - name: Get API URL
        id: get-api-url
        env:
          STAGE_NAME: ${{ inputs.stage_name }}
        run: |
          pushd cdk-eregs
          API_STACK="cms-eregs-${STAGE_NAME}-api"
          API_URL=$(cat api-outputs.json | jq -r ".[\"$API_STACK\"].ApiEndpoint")
          API_URL=${API_URL%/}
          # Debug what we're setting
          echo "Setting API URL: $API_URL"
          # Use the exact same name as in the outputs section
          echo "api_url=$(echo $API_URL)" >> $GITHUB_OUTPUT
          # Verify it was set
          echo "GITHUB_OUTPUT contents:"
          cat $GITHUB_OUTPUT
          popd

      - name: Notify Slack if failure occurs during site deployment
        if: ${{ inputs.pr_number == '' && failure() }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.PR_OBSERVER_SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: "<!channel> :warning: Deployment to *${{ inputs.environment }}* failed during site deployment. Please investigate. <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run.>"

  add-pr-comment:
    if: ${{ inputs.pr_number != '' }}
    permissions:
      pull-requests: write
    runs-on: ubuntu-22.04
    needs: deploy-site
    steps:
      - name: Create deployment comment
        uses: peter-evans/create-or-update-comment@v5
        env:
          SITE_URL: ${{ needs.deploy-site.outputs.api_url }}
        with:
          issue-number: ${{ inputs.pr_number }}
          body: |
            ✨ See the Django Site deployed at: ${{ env.SITE_URL }} ✨
          reactions: "+1"

  test-cypress:
    environment: ${{ inputs.environment }}
    runs-on: ubuntu-22.04
    needs: deploy-site
    steps:
      # Checkout the code
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: true

      # Configure AWS credentials for GitHub Actions
      - name: Configure AWS credentials for GitHub Actions
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_TO_ASSUME }}
          aws-region: ${{ inputs.aws_default_region }}

      # Get test user credentials from AWS Secret Manager
      - name: Get test user credentials
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            CYPRESS_TEST, /eregulations/http/credentials
            CYPRESS_READER, /eregulations/http/reader_credentials
          name-transformation: uppercase
          parse-json-secrets: true

      # Setup node environment
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 22

      # Run the cypress tests
      - name: end-to-end tests
        uses: cypress-io/github-action@v6
        with:
          working-directory: solution/ui/e2e
          config: baseUrl=${{ needs.deploy-site.outputs.api_url }}
        env:
          CYPRESS_DEPLOYING: true

      - name: Notify Slack if failure occurs cypress tests
        if: ${{ inputs.pr_number == '' && failure() }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.PR_OBSERVER_SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: "<!channel> :warning: Deployment to *${{ inputs.environment }}* failed during Cypress end-to-end tests. Please investigate. <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run.>"
